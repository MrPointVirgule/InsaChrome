<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<link rel="stylesheet" href="../css/style_page.css" />
		<title>Demineur</title>
	</head>
	
	<body>
		<div class="content-wrapper" id="content-dem">
			<h1>Demineur</h1></br>
			<div class="center" id="center-dem">
			
				<div id="game-bloc"></div>
				
				<div id="score">
					<h2 id="mines-rest">Mines restantes :</h2>
					<h2 id="mines-tot">Mines totales :</h2>
					<h2 id="cheat">Cheat</h2>
				</div>
			</div>
		</div>
	</body>
	<script type='text/javascript' src='../jquery-2.1.1.min.js'></script>
	<script>
			var colonnes = 5, lignes = 5;
			for(var j = 0; j < lignes;j++){ //nombre de liges
				$('#game-bloc').append('<div class="ligne-dem" id="l' + j + '"></div>');
				for(var i = 0; i < colonnes;i++){ //nombre de colonnes
					$('#l' + j).append('<img class="tile" id="case_' + (parseInt(i) + parseInt(j) * colonnes) + '" src="" alt="case de jeu" etat="hide" typecase="neutre" col="' + i + '" lig="' + j + '" onclick="flag(this)" ondblclick="turn(this)"/>');
				}
			}
			
			addMines(5,colonnes, lignes);
			
			/*for(var i = 0; i < colonnes * lignes;i++){
				var ligne = "";
				ligne += count('#case_'+i) + '|';
				if(i%colonnes == 0){
					console.log(ligne);
					ligne = "";
				}
			}*/
			
			function flag(id){
				if($(id).attr('etat') == "hide"){
					$(id).attr('src', "../content/Demineur/flag.png");
					$(id).attr('etat', "flagged");
				}else if($(id).attr('etat') == "flagged"){
					$(id).attr('src', "");
					$(id).attr('etat', "hide");
				}
				$("#mines-rest").html('Mines restantes : ' + (countMines() - countFlag()));
				$("#cheat").html('Cheat : ' + countFlaggedMine());
				victory();
			}
			
			function turn(id){
				if($(id).attr('etat') == "flagged" || $(id).attr('etat') == "hide"){
					$(id).attr('etat', "displayed");
					$(id).attr('style', "background-color: rgb(230,230,230);");
					if($(id).attr('typecase') == "neutre"){
						var cels = count(id);
						switch (cels){
							case 1:	$(id).attr('src', "../content/Demineur/1.png");
								break;
							case 2:	$(id).attr('src', "../content/Demineur/2.png");
								break;
							case 3:	$(id).attr('src', "../content/Demineur/3.png");
								break;
							case 4:	$(id).attr('src', "../content/Demineur/4.png");
								break;
							case 5:	$(id).attr('src', "../content/Demineur/5.png");
								break;
							case 6: $(id).attr('src', "../content/Demineur/6.png");
								break;
							case 7: $(id).attr('src', "../content/Demineur/7.png");
								break;
							case 8: $(id).attr('src', "../content/Demineur/8.png");
								break;
							default: 
								$(id).attr('src', "");
								
								var x = parseInt($(id).attr('col')),
								y = parseInt($(id).attr('lig'));
								for(var i = - 1; i <= 1;i++){
									for(var j = -1; j <= 1;j++){
										if((x+i >= 0) && (x+i <= colonnes) && (y+j >= 0) && (y+j <= lignes)){
											turn($('#case_' + ((x + i) + ((y + j) * colonnes))));
										}
									}
								}
								break;
						}
					}else if($(id).attr('typecase') == "mine"){
						$(id).attr('src', "../content/Demineur/mine.png");
					}
					
				}
			}
			
			function addMines(nbMines, col, lig){
				var rand;
				while(countMines() < nbMines){
					rand = Math.floor(Math.random() * col * lig);
					if($('#case_' + rand).attr('typecase',"neutre")){
						$('#case_' + rand).attr('typecase','mine');
					}
				}
				$("#mines-rest").html('Mines restantes : ' + (countMines() - countFlag()));
				$("#mines-tot").html('Mines totales : ' + countMines());
			}
			
			function countMines(){
				var mines = 0;
				for(var i = 0; i < colonnes * lignes; i++){
					if($('#case_' + i).attr('typecase') == "mine"){
						mines++;
					}
				}
				return mines;
			}
			
			function countFlag(){
				var flag = 0;
				for(var i = 0; i < colonnes * lignes; i++){
					if($('#case_' + i).attr('etat') == 'flagged'){
						flag++;
					}
				}
				return flag;
			}
			
			function countFlaggedMine(){
				var fmine = 0;
				for(var i = 0; i < colonnes * lignes; i++){
					if($('#case_' + i).attr('etat') == 'flagged' && $('#case_' + i).attr('typecase') == "mine"){
						fmine++;
					}
				}
				return fmine;
			}
			function count(id){
				
				var cels = 0,
					x = parseInt($(id).attr('col')),
					y = parseInt($(id).attr('lig'));
				
				for(var i = - 1; i <= 1;i++){
					for(var j = -1; j <= 1;j++){
						if((x+i >= 0) && (x+i <= colonnes) && (y+j >= 0) && (y+j <= lignes)){
							if($('#case_' + ((x + i) + ((y + j) * colonnes)) ).attr('typecase') == "mine"){
								cels = cels + 1;
							}
						}
					}
				}
				return $(id).attr('typecase') == 'mine' ? -1 : cels;
			}
			
			function victory(){
				if(countFlaggedMine() == countMines() && countFlag() == countFlaggedMine())
					alert('Victoire !'); 
			}
	</script>
</html>

<!-- http://openclassrooms.com/courses/dynamisez-vos-sites-web-avec-javascript/l-audio-et-la-video
http://dust.galadruin.fr:8000/Gatsun -->